# Setting up a cassandra cluster

# Run the provided ec2_reserve_3node_demo_cassandra_cluster.sh
./ec2_reserve_3node_demo_cassandra_cluster.sh

# Get your instance info in the terminal
instance_ids="$(aws ec2 describe-instance-status --query InstanceStatuses[*][InstanceId] --output text)"
publicDnsName="$(aws ec2 describe-instances --instance-ids $temp --query Reservations[*].Instances[*].NetworkInterfaces[*].Association.PublicDnsName --output text)"
c=0;for dns in $publicDnsName; do eval "dns$c=$dns";c=$((c+1));done
c=0;for id in $instance_ids; do eval "id$c=$id"; c=$((c+1));done


# For each instance
ssh -o StrictHostKeyChecking=no -i /etc/ssh/EC2-US-EAST-1A.pem ubuntu@$dns1
# In the instance
wget https://raw.githubusercontent.com/WillahScott/slack-pack/dev-env/env/cassandra_remote_install.sh
sudo chmod a+x cassandra_remote_install.sh
sudo ./cassandra_remote_install.sh
sudo vi /etc/cassandra/cassandra.yaml
	cluster_name: 'Demo Cluster'
	# Line 424
	# Set 2 of the 3 nodes as seeds
	seeds: "54.227.164.225,54.146.154.198" # This line is always the same for each node
	# Line 575 (change to blank)
	listen_address:
	# Line 589
	broadcast_address: 52.201.212.166 (the current machine's public ip)
exit

scp -i /etc/ssh/EC2-US-EAST-1A.pem ubuntu@$dns2:/etc/cassandra/cassandra.yaml cassandra_$dns2

# ssh back in to each instance
ssh -o StrictHostKeyChecking=no -i /etc/ssh/EC2-US-EAST-1A.pem ubuntu@$dns0
sudo service cassandra start

# Check status (Should see 3 nodes)
nodetool status

# Terminate instances
aws ec2 terminate-instances --instance-ids "$id0" "$id1" "$id2" --output text --query 'TerminatingInstances[*].CurrentState.Name'

